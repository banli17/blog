<script>

  let usedReactivities = []
  let handlers = new Map()

  function reactive(obj) {
    obj.data = new Proxy(obj.data, {
      get(obj, key) {
        console.log('get');
        usedReactivities.push([obj, key])
        return obj[key]
      },
      set(obj, key, val) {
        obj[key] = val

        if (handlers.has(obj) && handlers.get(obj).has(key)) {
          handlers.get(obj).get(key).forEach(fn => fn())
        }
        return obj[key]
      }
    })
    // for (let key in obj.data) {
    //   obj[key] = obj.data[key] 要将每个属性编程一个对象
    // }
    return obj
  }

  function effect(handler) {
    usedReactivity = []
    handler()
    console.log('usedReactivity', usedReactivities);
    for (let reactivity of usedReactivities) {
      let [obj, key] = reactivity
      if (!handlers.has(obj)) {
        handlers.set(obj, new Map)
      }
      if (!handlers.get(obj).get(key)) {
        handlers.get(obj).set(key, [])
      }
      console.log('gg', handlers.get(obj).get(key));
      handlers.get(obj).get(key).push(handler)
    }
    console.log('handlers', handlers);
  }

  let obj = {
    data: {
      count: 1
    }
  }
  // 改写原对象 obj, 数据格式必须是 obj.data 引用形式
  reactive(obj)
  let dummy

  effect(() => console.log('ggg'))
  effect(() => dummy = obj.data.count)
  console.log(dummy);
  obj.data.count = 2
  console.log(dummy);
  obj.data.count = 3
  console.log(dummy);

</script>
